# Copyright 2025 Cisco Systems, Inc. and its affiliates
#
# SPDX-License-Identifier: Apache-2.0

---
name: license-check

on:
  push:
    # Run license check on pushes to default branch
    branches:
      - main
  # Run license check on pull request events
  pull_request:

permissions:
  contents: read

jobs:
  get-source-files:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.list_files.outputs.files }}
    steps:
      - name: ðŸ”’ harden runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit
      - name: ðŸ“¦ checkout repository
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          persist-credentials: false
      - name: ðŸ—‚ï¸ get list of files
        id: list_files
        run: |
          FILES=$(find . -name '*.py' -o -name '*.yaml' -o -name '*.yml' | tr '\n' ' ')
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

  license-compliance-check:
    runs-on: ubuntu-latest
    needs: get-source-files
    steps:
      - name: ðŸ”’ harden runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit
      - name: ðŸ“¦ checkout repository
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          persist-credentials: false
      - name: ðŸ§¹ run license lint
        uses: fsfe/reuse-action@676e2d560c9a403aa252096d99fcab3e1132b0f5 # v6.0.0
        with:
          args: lint-file ${{ needs.get-source-files.outputs.files }}
